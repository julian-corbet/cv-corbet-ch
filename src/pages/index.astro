---
// src/pages/index.astro
import "@fontsource-variable/dm-sans";
import { getEntry, getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

import Header from "../components/Header.astro";
import Container from "../components/Container.astro";
import Footer from "../components/Footer.astro";
import { Icon } from "astro-icon/components";

// Load metadata.yaml (single source of truth)
const entry = await getEntry("config", "metadata");
const metadata = entry?.data;
if (!metadata) {
  console.error("Available config entries:", await getCollection("config"));
  throw new Error("Missing src/content/config/metadata.yaml or schema mismatch.");
}

// Build absolute social image URLs
const ogImageAbs = new URL(metadata.og.og_image_path, metadata.og.og_url).toString();
const twImageAbs = new URL(metadata.twitter.twitter_image_path, metadata.og.og_url).toString();

// Language for <html>
const lang = metadata.page?.page_lang ?? "en";
---

<BaseLayout lang={lang}>
  <Fragment slot="head">
    <!-- Theme init + toggle -->
    <script is:inline>
      const initTheme = () => {
        const theme = localStorage.getItem('theme') || 'black';
        document.documentElement.setAttribute('data-theme', theme);
        if (theme === 'black') document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      };
      initTheme();

      window.addEventListener('change', (e) => {
        if (e.target instanceof HTMLInputElement && e.target.matches('input[data-toggle-theme]')) {
          const theme = e.target.checked ? 'lofi' : 'black';
          document.documentElement.setAttribute('data-theme', theme);
          if (theme === 'black') document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', theme);
        }
      });
    </script>

    <!-- Hash navigation for accordion sections -->
    <script is:inline>
      function handleHash() {
        const id = window.location.hash.slice(1);
        if (!id) return;
        const el = document.getElementById(id);
        if (!el) return;

        const cc = el.closest('.collapse-content');
        if (cc) {
          const collapse = cc.closest('.collapse');
          const cb = collapse?.querySelector('input[type="checkbox"]');
          if (cb && !cb.checked) cb.checked = true;
        } else if (el.classList.contains('collapse')) {
          const cb = el.querySelector('input[type="checkbox"]');
          if (cb && !cb.checked) cb.checked = true;
        }

        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      window.addEventListener('DOMContentLoaded', handleHash);
      window.addEventListener('hashchange', handleHash);
    </script>

    <!-- Basics -->
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/favicon.webp" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style is:global>@import "/src/styles/global.css";</style>

    <!-- SEO -->
    <title>{metadata.seo.seo_title}</title>
    <meta name="description" content={metadata.seo.seo_description} />
    <meta name="keywords" content={metadata.seo.seo_keywords.join(", ")} />
    <meta name="author" content={metadata.seo.seo_author} />
    <meta name="theme-color" content={metadata.seo.seo_theme_color} />
    <link rel="canonical" href={metadata.seo.seo_canonical_url} />
    {metadata.seo.seo_noindex && <meta name="robots" content="noindex,nofollow" />}

    <!-- Open Graph -->
    <meta property="og:type" content={metadata.og.og_type} />
    <meta property="og:url" content={metadata.og.og_url} />
    <meta property="og:title" content={metadata.og.og_title} />
    <meta property="og:description" content={metadata.og.og_description} />
    <meta property="og:site_name" content={metadata.og.og_site_name} />
    <meta property="og:locale" content={metadata.og.og_locale} />
    <meta property="og:image" content={ogImageAbs} />
    <meta property="og:image:width" content={String(metadata.og.og_image_width)} />
    <meta property="og:image:height" content={String(metadata.og.og_image_height)} />

    <!-- Twitter -->
    <meta name="twitter:card" content={metadata.twitter.twitter_card} />
    <meta name="twitter:url" content={metadata.og.og_url} />
    <meta name="twitter:title" content={metadata.twitter.twitter_title} />
    <meta name="twitter:description" content={metadata.twitter.twitter_description} />
    {metadata.twitter.twitter_site && (
      <meta name="twitter:site" content={metadata.twitter.twitter_site} />
    )}
    {metadata.twitter.twitter_creator && (
      <meta name="twitter:creator" content={metadata.twitter.twitter_creator} />
    )}
    <meta name="twitter:image" content={twImageAbs} />

    <!-- Person JSON-LD -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Person",
        ...metadata.person
      })}
    />
  </Fragment>

  <body class="flex flex-col min-h-screen">
    <!-- Header + divider inside a unified page frame -->
    <div class="page-frame">
      <div class="frame-inner">
        <Header />
      </div>
      <div class="divider h-fit bg-secondary"></div>
    </div>

    <!-- Theme toggle (absolute) -->
    <div class="flex items-center absolute top-4 right-4 md:top-6 md:right-6 lg:top-8 lg:right-8 xl:top-10 xl:right-10 z-10">
      <Icon name="carbon:moon" class="w-4 h-4" />
      <input type="checkbox" data-toggle-theme="black,lofi" class="toggle toggle-sm mx-1 bg-secondary" />
      <Icon name="carbon:light" class="w-4 h-4" />
    </div>

    <!-- Main content in the same frame -->
    <main class="page-frame overflow-y-scroll py-2 max-h-[90vh] md:max-h-[70vh]">
      <div class="container">
        <Container />
      </div>
    </main>

    <!-- Footer in the same frame -->
    <div class="page-frame">
      <Footer class="flex justify-center items-center py-4" />
    </div>
  </body>
</BaseLayout>

<style is:global>
  /* Typography */
  body { font-family: "DM Sans Variable", sans-serif; }

  /* Unified centered frame:
     - same width across header/main/footer
     - mobile gutters (px)
     - no surprises from child widths */
  .page-frame {
    margin-inline: auto;
    width: min(95vw, 48rem); /* 48rem â‰ˆ Tailwind max-w-3xl */
    padding-inline: 1rem;    /* mobile gutters match visual center */
  }
  @media (min-width: 768px) {
    .page-frame { padding-inline: 0; } /* remove extra gutters on md+ to match main */
  }
  .frame-inner {
    max-width: 100%;
    margin-inline: auto;
    overflow: hidden; /* prevents accidental spill from inner absolute/flex elements */
  }

  /* Scrollbar cosmetics for the scrollable main */
  .overflow-y-scroll::-webkit-scrollbar { width: 3px; }
  .overflow-y-scroll::-webkit-scrollbar-thumb { background-color: oklch(var(--s)); }
  .overflow-y-scroll { scrollbar-width: 1px; }

  /* Your container behavior stays as-is */
  @media (max-width: 768px) { .container { flex-direction: column; } }
  @media (min-width: 768px) { .container { display: flex; flex-wrap: wrap; } }

  /* Theme-specific icon tweaks */
  [data-theme=black] .signal-icon { filter: invert(1); }
  [data-theme=black] .matrix-icon { filter: invert(1); }
  [data-theme=black] .threema-light { display: none; }
  [data-theme=black] .threema-dark { display: block; }
</style>