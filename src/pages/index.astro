---
import "@fontsource-variable/dm-sans";
import { getEntry, getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";

import Header from "../components/Header.astro";
import Container from "../components/Container.astro";
import Footer from "../components/Footer.astro";
import { Icon } from "astro-icon/components";

// Load metadata.yaml (single source of truth)
const entry = await getEntry("config", "metadata");
// Cast to any to work cleanly with the union schema
const metadata = entry?.data as any;

if (!metadata) {
  console.error("Available config entries:", await getCollection("config"));
  throw new Error("Missing src/content/config/metadata.yaml or schema mismatch.");
}

// Build absolute image URL for Twitter image
const twImageAbs = new URL(metadata.twitter.twitter_image_path, metadata.og.og_url).toString();

// Language for <html>
const lang = metadata.page?.page_lang ?? "en";
---

<BaseLayout lang={lang}>
  <Fragment slot="head">
    <!-- Theme init + toggle -->
    <script is:inline>
      const initTheme = () => {
        const theme = localStorage.getItem('theme') || 'black';
        document.documentElement.setAttribute('data-theme', theme);
        if (theme === 'black') document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
      };
      initTheme();

      window.addEventListener('change', (e) => {
        if (e.target instanceof HTMLInputElement && e.target.matches('input[data-toggle-theme]')) {
          const theme = e.target.checked ? 'lofi' : 'black';
          document.documentElement.setAttribute('data-theme', theme);
          if (theme === 'black') document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', theme);
        }
      });
    </script>

    <!-- Hash navigation for accordion sections -->
    <script is:inline>
      function handleHash() {
        const id = window.location.hash.slice(1);
        if (!id) return;
        const el = document.getElementById(id);
        if (!el) return;

        const cc = el.closest('.collapse-content');
        if (cc) {
          const collapse = cc.closest('.collapse');
          const cb = collapse?.querySelector('input[type="checkbox"]');
          if (cb && !cb.checked) cb.checked = true;
        } else if (el.classList.contains('collapse')) {
          const cb = el.querySelector('input[type="checkbox"]');
          if (cb && !cb.checked) cb.checked = true;
        }

        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      window.addEventListener('DOMContentLoaded', handleHash);
      window.addEventListener('hashchange', handleHash);
    </script>

    <!-- Basics -->
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/pics/favicon.webp" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style is:global>@import "/src/styles/global.css";</style>

    <!-- SEO -->
    <title>{metadata.seo.seo_title}</title>
    <meta name="description" content={metadata.seo.seo_description} />
    <meta name="keywords" content={metadata.seo.seo_keywords.join(", ")} />
    <meta name="author" content={metadata.seo.seo_author} />
    <link rel="canonical" href={metadata.seo.seo_canonical_url} />
    {metadata.seo.seo_noindex && <meta name="robots" content="noindex,nofollow" />}

    <!-- Open Graph -->
    <meta property="og:type" content={metadata.og.og_type} />
    <meta property="og:url" content={metadata.og.og_url} />
    <meta property="og:title" content={metadata.og.og_title} />
    <meta property="og:description" content={metadata.og.og_description} />
    <meta property="og:site_name" content={metadata.og.og_site_name} />
    <meta property="og:locale" content={metadata.og.og_locale} />

    <!-- OG Profile fields -->
    {metadata.og.profile_first_name && (
      <meta property="profile:first_name" content={metadata.og.profile_first_name} />
    )}
    {metadata.og.profile_last_name && (
      <meta property="profile:last_name" content={metadata.og.profile_last_name} />
    )}
    {metadata.og.profile_username && (
      <meta property="profile:username" content={metadata.og.profile_username} />
    )}
    {metadata.og.profile_gender && (
      <meta property="profile:gender" content={metadata.og.profile_gender} />
    )}

    <!-- OG Multi-image loop -->
    {metadata.og.og_images?.map((img: { path: string; width: number; height: number; alt?: string }) => {
      const abs = new URL(img.path, metadata.og.og_url).toString();
      return (
        <>
          <meta property="og:image" content={abs} />
          <meta property="og:image:width" content={String(img.width)} />
          <meta property="og:image:height" content={String(img.height)} />
          {img.alt && <meta property="og:image:alt" content={img.alt} />}
        </>
      );
    })}

    <!-- OG single-image fallback -->
    {!metadata.og.og_images && metadata.og.og_image_path && (
      <>
        <meta
          property="og:image"
          content={new URL(metadata.og.og_image_path, metadata.og.og_url).toString()}
        />
        {metadata.og.og_image_width && (
          <meta property="og:image:width" content={String(metadata.og.og_image_width)} />
        )}
        {metadata.og.og_image_height && (
          <meta property="og:image:height" content={String(metadata.og.og_image_height)} />
        )}
      </>
    )}

    <!-- Twitter -->
    <meta name="twitter:card" content={metadata.twitter.twitter_card} />
    <meta name="twitter:url" content={metadata.og.og_url} />
    <meta name="twitter:title" content={metadata.twitter.twitter_title} />
    <meta name="twitter:description" content={metadata.twitter.twitter_description} />
    {metadata.twitter.twitter_site && (
      <meta name="twitter:site" content={metadata.twitter.twitter_site} />
    )}
    {metadata.twitter.twitter_creator && (
      <meta name="twitter:creator" content={metadata.twitter.twitter_creator} />
    )}
    <meta name="twitter:image" content={twImageAbs} />

    <!-- Person JSON-LD -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Person",
        ...metadata.person
      })}
    />
  </Fragment>

  <body class="flex flex-col min-h-screen">
    <!-- Pass metadata into Header -->
    <Header metadata={metadata} />

    <div class="flex items-center absolute top-4 right-4 md:top-6 md:right-6 lg:top-8 lg:right-8 xl:top-10 xl:right-10 z-10">
      <Icon name="carbon:moon" class="w-4 h-4" />
      <input type="checkbox" data-toggle-theme="black,lofi" class="toggle toggle-sm mx-1 bg-secondary" />
      <Icon name="carbon:light" class="w-4 h-4" />
    </div>

    <div class="divider mx-auto h-fit max-w-3xl w-[95vw] flex flex-nowrap bg-secondary"></div>

    <main class="mx-auto flex-grow max-h-[90vh] md:max-h-[70vh] max-w-3xl overflow-y-scroll py-2 grid w-[95vw]">
      <div class="container">
        <Container />
      </div>
    </main>

    <Footer class="flex justify-center items-center py-4" />
  </body>
</BaseLayout>