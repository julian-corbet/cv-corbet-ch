---
import { Icon } from "astro-icon/components";
import AccordionLayout from "../layouts/AccordionLayout.astro";
import Card from "./Card.astro";
import { getCollection } from "astro:content";

// Load section configuration - try broader import first
const configModules = await import.meta.glob("../pages/config/*.md", { eager: true });
const headersModule = configModules["../pages/config/headers.md"];

console.log('DEBUG: headersModule:', headersModule);
console.log('DEBUG: headersModule?.frontmatter:', (headersModule as any)?.frontmatter);

const sectionConfig = (headersModule as any)?.frontmatter || { sections: [] };

const normaliseOrder = (v: unknown) =>
  (typeof v === "number" && Number.isFinite(v)) ? v : Number.POSITIVE_INFINITY;

const sectionsWithContent = [];
for (const section of sectionConfig.sections ?? []) {
  const items = await getCollection(section.folder);
  const visible = items
    .filter((e) => e.data?.hidden !== true)
    .sort((a, b) => {
      const aO = normaliseOrder(a.data?.order);
      const bO = normaliseOrder(b.data?.order);
      if (aO !== bO) return aO - bO;
      return a.slug.localeCompare(b.slug);
    })
    .map((e) => ({ frontmatter: e.data, content: e.body }));

  sectionsWithContent.push({ ...section, items: visible });
}

// Log debug info
console.log("DEBUG sections:", sectionsWithContent.map(s => [s.title, s.items.length]));

const fileMeta = Object.values(await import.meta.glob("../pages/config/downloads.md", { eager: true })) as any[];
---

<div class="join join-vertical gap-1">
{
  sectionsWithContent.map((section) => {
    if (!section?.items || section.items.length === 0) return null;

    return (
      <AccordionLayout title={section.title} icon={section.icon}>
        {
          section.items.map((item) => (
            <Card frontmatter={item.frontmatter} content={item.content} />
          ))
        }
      </AccordionLayout>
    );
  })
}

  {fileMeta.length > 0 && (
    <Fragment>
      <AccordionLayout title={sectionConfig.special?.downloads?.title || "Downloads"} icon={sectionConfig.special?.downloads?.icon || "carbon:volume-file-storage"} id={"downloads"}>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {
            fileMeta.map((meta) => {
              return meta.frontmatter.downloads.map((file) => {
                if (file.type === "folder") {
                  return (
                    <div class="h-full">
                      <div class="collapse collapse-arrow bg-base-100 border border-[oklch(var(--s))] w-full rounded-box h-full text-base-content folder-collapse">
                        <input type="checkbox" />
                        <figure class="collapse-open:hidden flex flex-col items-center justify-center h-[150px] bg-base-100 rounded-t-box">
                          <div class="text-center">
                            <Icon name="carbon:folder" class="w-36 h-36 text-base-content mb-2" />
                            <h2 class="text-base-content font-bold text-center">{file.title} <br/> {file.children.length} Files</h2>
                          </div>
                        </figure>
                        <div class="collapse-title font-extrabold tracking-tight px-4"></div>
                        <div class="collapse-content px-4 pb-4">
                          {file.children.map((child) => {
                            const childPdfUrl = `/${child.filename}`;
                            return (
                              <div class="card card-compact card-bordered border-[oklch(var(--s))] w-full hover:shadow-lg transition-all mb-4">
                                <div class="card-body p-3">
                                  <h3 class="card-title text-lg">{child.title}</h3>
                                  <p class="text-sm">{child.description}</p>
                                  <div class="card-actions justify-center">
                                    <a target="_blank" href={childPdfUrl}>
                                      <button class="btn btn-sm btn-outline">
                                        {child.button}
                                        <Icon name="carbon:document-pdf" class="w-4 h-4 ml-1" />
                                      </button>
                                    </a>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  );
                } else {
                  const pdfUrl = `/${file.filename}`;
                  return (
                    <div class="h-full">
                      <div
                        class="card card-compact card-bordered border-[oklch(var(--s))] w-full hover:shadow-lg transition-all h-full"
                      >
                        <figure>
                          <object data={pdfUrl} type="application/pdf" width="100%" height="150px"></object>
                        </figure>
                        <div class="card-body">
                          <h2 class="card-title">{file.title}</h2>
                          <p>{file.description}</p>
                          <div class="card-actions justify-center">
                            <a target="_blank" href={pdfUrl}>
                              <button class="btn btn-outline">
                                {file.button}
                                <Icon name="carbon:document-pdf" class="w-4 h-4 ml-1" />
                              </button>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                }
              });
            })
          }
        </div>
      </AccordionLayout>

      <script is:inline>
        document.querySelectorAll('.folder-collapse input').forEach((input) => {
          const figure = input.closest('.folder-collapse').querySelector('figure');
          input.addEventListener('change', () => {
            figure.style.display = input.checked ? 'none' : 'flex';
          });
        });
      </script>
    </Fragment>
  )}
</div>
